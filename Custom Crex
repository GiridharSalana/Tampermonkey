// ==UserScript==
// @name         Custom Crex
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  TTS score announcer for crex.com live matches
// @author       You
// @match        https://crex.com/*
// @match        https://crex.live/*
// @icon         https://crex.com/assets/icon/favicon.ico
// @grant        none
// @run-at       document-idle
// ==/UserScript==

var isMute = localStorage.getItem('isMute');
var volume = localStorage.getItem('volume');

isMute = isMute !== null ? isMute : true;
volume = volume !== null ? volume : '50';

isMute = isMute === 'true';

const SELECTORS = {
    container_div: '.live-score-header.mob-none app-match-details-wrapper .team-result > div',
    score_element: '.live-score-header.mob-none app-match-details-wrapper .team-result > div > span',
    score_runs: '.live-score-header.mob-none app-match-details-wrapper .team-score > div > span:first-child',
    score_overs: '.live-score-header.mob-none app-match-details-wrapper .team-score > div > span:nth-child(2)',
};
const LOG_PREFIX = '[CustomCrex]';
const STABILIZE_MS = 2500;

let scoreObserver = null;
let lastUrl = location.href;
let initialized = false;

function log(...args) {
    console.log(LOG_PREFIX, ...args);
}

(function () {
    'use strict';

    if (!window.location.pathname.startsWith('/scoreboard/')) {
        log('Not a match page, waiting for SPA navigation...');
        monitorUrlChanges();
        return;
    }

    initScript();
})();

function monitorUrlChanges() {
    const urlObserver = new MutationObserver(() => {
        if (location.href !== lastUrl) {
            lastUrl = location.href;
            if (window.location.pathname.startsWith('/scoreboard/')) {
                log('Navigated to match page:', location.href);
                cleanup();
                setTimeout(initScript, STABILIZE_MS);
            }
        }
    });
    urlObserver.observe(document.body, { childList: true, subtree: true });
}

function cleanup() {
    if (scoreObserver) {
        scoreObserver.disconnect();
        scoreObserver = null;
    }
    const existing = document.getElementById('crex-tts-controls');
    if (existing) existing.remove();
    const existingSlider = document.getElementById('crex-volume-container');
    if (existingSlider) existingSlider.remove();
    initialized = false;
}

function initScript() {
    if (initialized) return;
    initialized = true;
    log('Initializing on:', location.href);

    monitorUrlChanges();

    injectStyles();

    waitForElementToExist(SELECTORS.container_div).then(element => {
        log('Found container, injecting controls...');
        var myDiv = element;
        myDiv.style.display = "flex";
        myDiv.style.flexDirection = "column";

        const voiceSelector_Elem = document.createElement("div");
        const voiceSelector = document.createElement('select');
        voiceSelector.id = 'voiceSelect';
        voiceSelector.className = "none";
        voiceSelector_Elem.appendChild(voiceSelector);

        const TopElement = document.createElement("div");
        TopElement.id = 'crex-tts-controls';
        TopElement.style.display = 'flex';
        TopElement.style.alignItems = 'center';
        TopElement.style.padding = '10px';

        const newElement_1 = document.createElement("div");
        newElement_1.textContent = "ðŸ”‡";
        newElement_1.id = "mute-btn-1";
        newElement_1.style.cursor = "pointer";
        newElement_1.style.padding = '10px';

        const newElement_2 = document.createElement("div");
        newElement_2.textContent = "ðŸ”‡";
        newElement_2.id = "mute-btn-2";
        newElement_2.style.cursor = "pointer";
        newElement_2.style.padding = '10px';

        const volumeSliderContainer = document.createElement('div');
        volumeSliderContainer.id = 'crex-volume-container';
        volumeSliderContainer.className = 'volume-slider-container';

        const lowVolumeIcon = document.createElement('span');
        lowVolumeIcon.className = 'volume-icon';
        lowVolumeIcon.textContent = 'ðŸ”‰';

        const volumeSlider = document.createElement('input');
        volumeSlider.type = 'range';
        volumeSlider.className = 'volume-slider';
        volumeSlider.min = '0';
        volumeSlider.max = '100';
        volumeSlider.value = volume;

        const highVolumeIcon = document.createElement('span');
        highVolumeIcon.className = 'volume-icon';
        highVolumeIcon.textContent = 'ðŸ”Š';

        volumeSliderContainer.appendChild(lowVolumeIcon);
        volumeSliderContainer.appendChild(volumeSlider);
        volumeSliderContainer.appendChild(highVolumeIcon);

        volumeSliderContainer.style.display = 'flex';
        volumeSliderContainer.style.alignItems = 'center';

        TopElement.appendChild(newElement_1);
        TopElement.appendChild(voiceSelector_Elem);
        TopElement.appendChild(newElement_2);

        myDiv.insertBefore(TopElement, myDiv.firstChild);
        myDiv.insertBefore(volumeSliderContainer, myDiv.firstChild.nextSibling);

        updateMuteUI(newElement_1, newElement_2);

        function spanClickEvent() {
            isMute = !isMute;
            localStorage.setItem('isMute', isMute);
            updateMuteUI(newElement_1, newElement_2);
            if (isMute) {
                window.speechSynthesis.cancel();
            }
        }
        newElement_1.addEventListener("click", spanClickEvent);
        newElement_2.addEventListener("click", spanClickEvent);

        document.addEventListener('keydown', function (event) {
            if (event.key === 'm') {
                newElement_1.click();
            }
        });

        populateVoiceList();

        volumeSlider.addEventListener('input', function () {
            volume = volumeSlider.value;
            localStorage.setItem('volume', volume);
        });

        setupScoreMonitor();
    }).catch(err => log('Container not found:', err.message));
}

function updateMuteUI(btn1, btn2) {
    if (isMute) {
        btn1.textContent = "ðŸ”‡";
        btn2.textContent = "ðŸ”‡";
        btn1.setAttribute("title", "Muted");
        btn2.setAttribute("title", "Muted");
    } else {
        btn1.textContent = "ðŸ”Š";
        btn2.textContent = "ðŸ”Š";
        btn1.setAttribute("title", "UnMuted");
        btn2.setAttribute("title", "UnMuted");
    }
}

function setupScoreMonitor() {
    waitForElementToExist(SELECTORS.score_element).then(scoreEl => {
        log('Score element found, starting monitor...');
        scoreObserver = new MutationObserver(() => {
            changeCallback();
        });
        scoreObserver.observe(scoreEl, {
            childList: true,
            characterData: true,
            subtree: true,
            attributes: false,
        });
    }).catch(err => log('Score element not found:', err.message));
}

function changeCallback() {
    let el = document.querySelector(SELECTORS.score_element);
    if (!el) return;
    el.style.cursor = "pointer";
    let text = el.innerText.trim();
    if (!text) return;
    audioAnnouncer(text);
    scoreAnnouncer(text);
}

function audioAnnouncer(text) {
    if (!('speechSynthesis' in window)) {
        log('Text-to-speech is not supported in this browser.');
        return;
    }
    if (isMute) return;

    const synth = window.speechSynthesis;
    const utterance = new SpeechSynthesisUtterance(text);
    let voiceSelect = document.getElementById('voiceSelect');
    if (voiceSelect) {
        let voices = synth.getVoices();
        let selectedVoice = voices.find(v => v.name === voiceSelect.value);
        if (selectedVoice) utterance.voice = selectedVoice;
    }
    utterance.volume = convertVolume(volume);
    synth.speak(utterance);
}

function scoreAnnouncer(text) {
    if (text.toLowerCase().trim() !== 'over') return;

    const runsEl = document.querySelector(SELECTORS.score_runs);
    const oversEl = document.querySelector(SELECTORS.score_overs);

    if (runsEl && oversEl) {
        let runs_wkt = runsEl.innerText.trim();
        let overs = oversEl.innerText.trim();
        let scoreScript = runs_wkt.replace('-', ' Runs For ') + ' Wickets and ' + parseInt(overs) + ' Overs.';
        log('Over summary:', scoreScript);
        audioAnnouncer(scoreScript);
    }
}

function convertVolume(volumeString) {
    let volumeInt = parseInt(volumeString, 10);
    if (isNaN(volumeInt) || volumeInt < 0 || volumeInt > 100) {
        return 0.5;
    }
    return volumeInt / 100;
}

function injectStyles() {
    const style = document.createElement('style');
    style.id = 'crex-custom-styles';
    style.textContent = `
        app-match-projected-score { display: none !important; }
        app-match-inning-wise-session { display: none !important; }
        .comm-wrap.comm-left-section { margin: 0 auto !important; }
    `;
    document.head.appendChild(style);
}

function waitForElementToExist(selector, timeout = 30000) {
    return new Promise((resolve, reject) => {
        const startTime = Date.now();

        const tryResolve = () => {
            setTimeout(() => {
                const el = document.querySelector(selector);
                if (el) {
                    resolve(el);
                } else {
                    startObserving();
                }
            }, STABILIZE_MS);
        };

        const startObserving = () => {
            const el = document.querySelector(selector);
            if (el) {
                tryResolve();
                return;
            }

            if (Date.now() - startTime > timeout) {
                reject(new Error('Timeout: ' + selector));
                return;
            }

            const observer = new MutationObserver(() => {
                if (document.querySelector(selector)) {
                    observer.disconnect();
                    tryResolve();
                }
            });

            observer.observe(document.body, {
                subtree: true,
                childList: true,
            });

            setTimeout(() => {
                observer.disconnect();
                if (!document.querySelector(selector)) {
                    reject(new Error('Timeout: ' + selector));
                }
            }, timeout - (Date.now() - startTime));
        };

        startObserving();
    });
}

function getVoices() {
    return new Promise((resolve, reject) => {
        if (!('speechSynthesis' in window)) {
            reject(new Error('Speech synthesis not supported'));
            return;
        }
        let synth = window.speechSynthesis;
        let voices = synth.getVoices();
        if (voices.length > 0) {
            resolve(voices);
            return;
        }
        synth.onvoiceschanged = () => {
            resolve(synth.getVoices());
        };
    });
}

function populateVoiceList() {
    let voiceSelect = document.getElementById('voiceSelect');
    if (!voiceSelect) return;

    getVoices()
        .then(voices => {
            voices.forEach(voice => {
                let option = document.createElement('option');
                option.textContent = voice.name;
                option.setAttribute('data-lang', voice.lang);
                option.setAttribute('data-name', voice.name);
                voiceSelect.appendChild(option);
            });
            let selectedVoice = localStorage.getItem('selectedVoice');
            if (selectedVoice) {
                voiceSelect.value = selectedVoice;
            }
        })
        .catch(error => {
            log('Error retrieving voices:', error);
        });

    voiceSelect.addEventListener('change', function () {
        localStorage.setItem('selectedVoice', voiceSelect.value);
    });
}
